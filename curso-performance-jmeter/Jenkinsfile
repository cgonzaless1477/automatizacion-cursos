pipeline {
    agent any

    environment {
        // Ruta donde está instalado JMeter en el servidor
        JMETER_HOME        = 'C:/apache-jmeter-5.6.3'
        // Ruta al plan de pruebas, relativa a la carpeta curso-performance-jmeter
        JMETER_TEST_PLAN   = 'test/escenario-principal.jmx'
        // Carpeta donde guardaremos los resultados
        JMETER_RESULTS_DIR = 'target/jmeter'
    }

    stages {
        stage('Verificar entorno') {
            steps {
                dir('curso-performance-jmeter') {
                    bat '''
                        echo ===== Verificando JMeter =====
                        "%JMETER_HOME%/bin/jmeter.bat" -v
                    '''
                }
            }
        }

        stage('Ejecutar pruebas de performance') {
            steps {
                dir('curso-performance-jmeter') {
                    bat """
                        echo ===== Carpeta actual =====
                        cd

                        REM Borrar reporte anterior si existe
                        if exist \"%JMETER_RESULTS_DIR%\\report\" rmdir /s /q \"%JMETER_RESULTS_DIR%\\report\"

                        REM Crear carpeta base de resultados si no existe
                        if not exist \"%JMETER_RESULTS_DIR%\" mkdir \"%JMETER_RESULTS_DIR%\"

                        REM Ejecutar JMeter en modo no gráfico
                        \"%JMETER_HOME%/bin/jmeter.bat\" -n ^
                          -t \"%JMETER_TEST_PLAN%\" ^
                          -l \"%JMETER_RESULTS_DIR%/resultados.jtl\" ^
                          -e -o \"%JMETER_RESULTS_DIR%/report\"
                    """
                }
            }
        }
    }

    post {
        always {
            dir('curso-performance-jmeter') {
                // Guardar artefactos de JMeter (.jtl + reporte HTML)
                archiveArtifacts artifacts: 'target/jmeter/**/*',
                                 fingerprint: true,
                                 allowEmptyArchive: true

                // Publicar reporte de performance a partir del .jtl
                perfReport(
                    errorFailedThreshold: 10,       // FAIL si errores >= 10%
                    errorUnstableThreshold: 1,      // UNSTABLE si errores >= 1%
                    sourceDataFiles: 'target/jmeter/resultados.jtl'
                )
            }
        }
    }
}
