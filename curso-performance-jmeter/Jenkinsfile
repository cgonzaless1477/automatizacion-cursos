pipeline {
    agent any

    // ðŸ”§ Variables de entorno (ajusta la ruta de JMeter)
    environment {
        // Ruta donde instalaste JMeter en tu mÃ¡quina/Jenkins
        JMETER_HOME = 'C:\apache-jmeter-5.6.3\'

        // Ruta del plan de pruebas JMeter dentro del repo
        JMETER_TEST_PLAN = 'curso-performance-jmeter\\tests\\escenario-principal.jmx'

        // Carpeta de resultados
        JMETER_RESULTS_DIR = 'target\\jmeter'
    }

    // ðŸ”” Opcional: que revise cambios cada 5 minutos
    triggers {
        // comenta esta lÃ­nea si quieres que solo se ejecute manual
        pollSCM('H/5 * * * *')
    }

    stages {

        stage('Verificar entorno') {
            steps {
                dir('curso-performance-jmeter') {
                    bat 'echo ===== Verificando JMeter ====='
                    bat '"%JMETER_HOME%\\bin\\jmeter.bat" -v'
                }
            }
        }

        stage('Ejecutar pruebas de performance') {
            steps {
                dir('curso-performance-jmeter') {
                    // Crear carpeta de resultados si no existe
                    bat 'if not exist %JMETER_RESULTS_DIR% mkdir %JMETER_RESULTS_DIR%'

                    // Ejecutar JMeter en modo no grÃ¡fico
                    bat "\"%JMETER_HOME%\\bin\\jmeter.bat\" -n -t %JMETER_TEST_PLAN% -l %JMETER_RESULTS_DIR%\\resultados.jtl -e -o %JMETER_RESULTS_DIR%\\report"
                }
            }
        }
    }

    post {
        always {
            dir('curso-performance-jmeter') {
                // Publicar todo lo que se generÃ³ en target/jmeter
                archiveArtifacts artifacts: 'target/jmeter/**/*',
                                 fingerprint: true,
                                 allowEmptyArchive: true
            }
        }
    }
}
